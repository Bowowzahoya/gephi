# -*- coding: utf-8 -*-
"""
Data source agnostic functions for creating
all edges and nodes

Main functions:
    - get_nodes_edges()
    - get_nodes()
    - get_edges()
"""
import pandas as pd

import .scopus as sc
import .lens_patent as lp

LB_COL = "Label"
SR_COL = "Strength"
SZ_COL = "Size"
IS_COL = "Internal similarity"
ID_COL = "Id"
SC_COL = "Source"
TG_COL = "Target"
W_COL = "Weight"

def get_nodes_edges(fnames, known_ams=pd.Series(), db="scopus", 
                    int_sim=False, fold="", **kwargs):
    """
    Create nodes and edges in Gephi format from filenames

    Parameters
    ----------
    fnames : list-like
        List of filename strings
    known_ams : Series
        Dictionary of known amounts per filename
    db (Optional): string, default "scopus"
        database used (for now only "scopus" possible)
    int_sim (Optional): bool, default False
        whether to calculate internal similarity or not (will take more time)

    Returns
    -------
    nodes : DataFrame
        nodes in Gephi format
    edges : DataFrame
        edges in Gephi format

    """
    nodes = get_nodes(fnames, known_ams=pd.Series(), db=db, int_sim=int_sim, 
                      fold=fold, **kwargs)
    
    edges = get_edges(fnames, known_ams=pd.Series(), db=db, fold=fold,
                      **kwargs)

    return nodes, edges
            
def get_nodes(fnames, known_ams=pd.Series(), db="scopus", 
              int_sim=False, fold="", **kwargs):
    
    if db == "scopus":
        get_node = sc.get_node
        get_int_sim = sc.get_int_sim
    elif db == "lens_patent":
        get_node = lp.get_node
        get_int_sim = lp.get_int_sim
    else:
        raise Exception(f"db {db} not valid.")
        
    columns = [LB_COL, SZ_COL]
    if int_sim: columns.append(IS_COL)
    nodes = pd.DataFrame(columns=columns)
    

    for i, fname in enumerate(fnames):
        print(f"Reading node '{fname}'...")
        name = fname[:-4]
        nodes.loc[name, LB_COL] = name
        try:
            nodes.loc[name, SZ_COL] = get_node(fname, known_ams, fold=fold)
        except:
            print(f"Error while loading file '{fname}'. Error:")
            raise
        if int_sim:
            try:
                nodes.loc[name, IS_COL] = get_int_sim(fname, fold=fold)
            except:
                print(f"Error while calculating internal similarity for '{fname}'. Error:")
                raise
    nodes.index.name = ID_COL
    return nodes

def get_edges(fnames, known_ams=pd.Series(), db="scopus", 
              fold="", **kwargs):
    if db == "scopus":
        get_edge = sc.get_edge
    elif db == "lens_patent":
        get_edge = lp.get_edge
    else:
        raise Exception(f"db {db} not valid.")
    
    columns = [SC_COL, TG_COL, W_COL]
    edges = pd.DataFrame(columns=columns)
    
    i = 0
    for j, fname1 in enumerate(fnames):
        print(f"Reading edges for '{fname1}'")
        for k, fname2 in enumerate(fnames):
            if fname1==fname2:
                continue
            print(f"\t with '{fname2}'...")
            
            name1 = fname1[:-4]
            name2 = fname2[:-4]
            edges.loc[i, SC_COL] = name1
            edges.loc[i, TG_COL] = name2
            try:
                edges.loc[i, W_COL] = get_edge(fname1, fname2, known_ams, fold=fold)
            except:
                print(f"Error while loading file '{fname2}'. Error:")
                raise
            i +=  1
    return edges
    
    